<!DOCTYPE html>
<html>
<head>
	<title>PyTeamsExporter - Daniel Green</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
</head>
<body>

  <nav class="py-2 bg-light border-bottom">
    <div class="container d-flex flex-wrap">
			<div class="nav me-auto align-items-center">
			Logged in as {{username}} ({{ email }})
			</div>
      <ul class="nav">
        <li id="logout" class="nav-item"><a href="#" class="nav-link link-dark px-2">Sign out</a></li>
      </ul>
    </div>
  </nav>

	<!-- Get Chats (Error) Toast -->
	<div class="toast-container position-absolute p-3" style="z-index: 999;">
		<div id="toast_getchats" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="d-flex">
				<div class="toast-body">
					ERROR MESSAGE HERE
				</div>
				<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		</div>
	</div>

	<!-- Download Selected Chats (Error) Toast -->
	<div class="toast-container position-absolute p-3" style="z-index: 999;">
		<div id="toast_downloadchats" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="d-flex">
				<div class="toast-body">
					ERROR MESSAGE HERE
				</div>
				<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		</div>
	</div>

	<main class="container py-4">
		<button id="get_chats" class="btn btn-primary btn-lg" type="button">Get Chat History</button>
		<button id="download_chats" class="btn btn-success btn-lg disabled" type="button">Download Selected Chats</button>
		<br/><br/>
		<button id="chats_select_all" type="button" class="btn btn-dark btn-sm">Select All</button>
		<button id="chats_select_none" type="button" class="btn btn-dark btn-sm">Select None</button>
		<table id="chats_table_header" class="table table-striped table-hover table-responsive">
			<thead>
				<tr>
					<th scope="col">Export</th>
					<th scope="col">Topic</th>
					<th scope="col">Type</th>
					<th scope="col">Members</th>
					<th scope="col">Link</th>
				</tr>
			</thead>
		</table>
		<div style="max-height: 70vh; overflow: auto;">
			<table id="chats_table" class="table table-striped table-hover table-responsive">
				<tbody>
					<tr>
						<td scope="row"><input class="chat-checkbox form-check-input" type="checkbox" value=""></td>
						<td>Topic</td>
						<td>Type</td>
						<td>Members</td>
						<td>Link</td>
					</tr>
				</tbody>
			</table>
		</div>

	</main>


	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>

	<script>
		var toastEls = [].slice.call(document.querySelectorAll('.toast'));
		toastEls.map(function(el) {
			new bootstrap.Toast(el, {})
		});

		var chat_ids = [];

		$('#logout').click(function(evt) {
			const endpoint = location.origin + '/logout';
			window.location.replace(endpoint);
			evt.preventDefault();
		});

		$('#chats_select_all').click(function(evt) {
			$('.chat-checkbox').each(function(index, el) {
				$(el).prop('checked', true);
			});
			evt.preventDefault();
		});

		$('#chats_select_none').click(function(evt) {
			$('.chat-checkbox').each(function(index, el) {
				$(el).prop('checked', false);
			});
			evt.preventDefault();
		});

		$('#download_chats').click(function(evt) {
			const endpoint = location.origin + '/get_chat';

			const btn = $(this);
			const loadingText = "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Downloading...";
			if(btn.html() !== loadingText) {
				btn.data('original-text', btn.html());
				btn.html(loadingText);
			}
			btn.addClass('disabled');

			$('.chat-checkbox').each(function(index, el) {
				const checked = $(el).prop('checked');
				if(checked) {
					const chat_id = chat_ids[index];
					const data = {
						chat_id: chat_id
					};
					console.log(data);

					$.ajax({
						type: 'POST',
						url: endpoint,
						data: JSON.stringify(data),
						contentType: 'application/json',
						dataType: 'text',
						success: function(res) {
							var blob = new Blob([res], {type: 'text'});
							var url = window.URL.createObjectURL(blob);
							var link = document.createElement('a');
							document.body.appendChild(link);
							link.style = 'display: none';
							link.href = url;
							link.download = chat_id + '.html';
							link.click();

							setTimeout(() => {
								window.URL.revokeObjectURL(url);
								link.remove();
							}, 100);

							btn.html(btn.data('original-text'));
							btn.removeClass('disabled');

							// console.log(res);
						},
						error: function(xhr, msg, err) {
							btn.html(btn.data('original-text'));
							btn.removeClass('disabled');

							const json_err = JSON.parse(xhr.responseText);
							const toast_el = $('#toast_downloadchats');
							toast_el.find('.toast-body').text("Failed to download chats. (" + json_err.message + ")");
							toast_el.toast('show');

							console.log(xhr);
							console.log(xhr.responseText);
						}
					});
				}
			});
			evt.preventDefault();
		});

		$('#get_chats').click(function(evt) {
			const endpoint = location.origin + '/get_all_chats';

			const btn = $(this);
			const loadingText = "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Loading...";
			if(btn.html() !== loadingText) {
				btn.data('original-text', btn.html());
				btn.html(loadingText);
			}
			btn.addClass('disabled');

			$.ajax({
				type: 'GET',
				url: endpoint,
				contentType: 'application/json',
				success: function(data) {
					console.log(data);

					clear_chats();

					chat_ids = [];

					for(var i=0; i < data.length; ++i) {
						add_chat_entry(data[i]);
						chat_ids.push(data[i].id);
					}

					if(chat_ids.length > 0) {
						$('#download_chats').removeClass('disabled');
					}

					btn.html(btn.data('original-text'));
					btn.removeClass('disabled');
				},
				error: function(xhr, msg, err) {
					btn.html(btn.data('original-text'));
					btn.removeClass('disabled');

					const json_err = JSON.parse(xhr.responseText);
					const toast_el = $('#toast_getchats');
					toast_el.find('.toast-body').text("Failed to retrieve chat history (" + json_err.message + ")" );
					toast_el.toast('show');
					
					console.log(xhr);
					console.log(xhr.responseText);
				}
			});

			evt.preventDefault();
		});

		function clear_chats() {
			const table = $('#chats_table tbody');
			table.empty();
		}

		function add_chat_entry(item) {
			const table = $('#chats_table tbody');

			const row = document.createElement('tr');

			const chkRow = create_row_column(row);
			chkRow.innerHTML = "<input class=\"chat-checkbox form-check-input\" type=\"checkbox\" value=\"\">";

			// const indexRow = create_row_column(row);
			// indexRow.innerText = item.index;

			const topicRow = create_row_column(row);
			if(item.topic == null || item.topic.length == 0) {
				topicRow.innerText = 'Unnamed Chat';
			} else {
				topicRow.innerText = item.topic;
			}

			const typeRow = create_row_column(row);
			typeRow.innerText = item.type;

			const membersRow = create_row_column(row);
			membersRow.innerText = item.members;

			const linkRow = create_row_column(row);
			linkRow.innerHTML = '<a href=\"' + item.link + '\" target=_blank>Link<a/>';
			
			table.append(row);
		}

		function create_row_column(row) {
			const col = document.createElement('td');
			row.append(col);
			return col;
		}

		// function match_table_headers() {
		// 	const header = $('#chats_table_header thead');
		// 	const table = $('#chats_table tbody');

		// 	const heads = header.find('tr th');
		// 	const table_tds = table.find('tr').first().find('td');
		// 	console.log(heads.length);
		// 	console.log(table_tds.length);

		// 	if(heads.length != table_tds.length) {
		// 		return;
		// 	}

		// 	for(var i=0; i < heads.length; ++i) {
		// 		const desiredWidth = $(table_tds[i]).width();
		// 		$(heads[i]).width(desiredWidth);
		// 	}
		// }
	</script>
</body>
</html>
